# Bedienungsanleitung der Nachthimmelmonitoring-Anwendung Naturpark Gantrisch

Dies ist die Anleitung für die Nachthimmelmonitoring-Anwendung, die speziell für die Analyse und Visualisierung von Daten aus Photometermessungen im Naturpark Gantrisch entwickelt wurde.

## Installation

### Voraussetzungen

- **Docker**: Installieren Sie Docker in der Version `xyz` oder höher.
- **Systemanforderungen**: Ein Rechner mit **Windows 10** oder höher bzw. ein kompatibles Betriebssystem.
- **Internetverbindung**: Für den Zugriff auf aktuelle Daten und Software-Updates.

### Schritte zur Installation

Die Anleitung für die Installation finden Sie hier: [GitHub](https://github.com/NachthimmelMonitoringGantrisch/NachthimmelMonitoringGantrisch):

---

## Übersicht der Anwendung

Die Anwendung besteht aus drei Haupttabs:

1. **Daten herunterladen**: Laden Sie die Daten basierend auf einem definierten Zeitraum und Photometer herunter.
2. **Photometer Analyse**: Visualisieren und analysieren Sie die Messdaten.
3. **Analyse Report**: Exportieren Sie Berichte über ausgewählte Analysen. (Diese Funktion ist nicht umgesetzt)

---

## 1. Daten herunterladen

In diesem Tab können Sie Messdaten aus einem definierten Zeitraum abrufen:

- **Zeitraum-Auswahl**: Wählen Sie über den **Datumsbereich-Selektor** einen Zeitraum aus.
- **Photometer-Auswahl**: Wählen Sie über die **Metadatentabelle** einen oder mehrere Photometer aus.
- **Daten herunterladen**: Drücken Sie den Button **Daten herunterladen**, um die Daten in einer Tabelle anzuzeigen.
- **Statusbereich**: Statusmeldungen werden im **Statusbereich** angezeigt, um den Status des Downloads zu überwachen.

---

## 2. Photometer Analyse

Im **Photometer Analyse**-Tab können Sie aus verschiedenen Analysen wählen:

### Analyse Typen

- **Photometer Statistik**: Zeigt detaillierte Statistiken zu den gesammelten Daten an.
- **Analyse pro Jahr**: Histogramme der Daten eines oder mehrerer Jahre.
- **Analyse pro Monat**: Grafiken für monatliche Messwerte (Minimum, Maximum).
- **Analyse Einzelnächte**: Detailanalysen einzelner Nächte.
- **Photometer Vergleich**: Vergleicht Daten von zwei ausgewählten Photometern. (Diese Funktion ist nicht umgesetzt)

### Bedienung

- **Analyse Typ wählen**: Nutzen Sie die Dropdown-Menüs, um den gewünschten Analysemodus und die entsprechenden Parameter (z. B. Jahr, Monat, Photometer) auszuwählen.
- **Dynamische Visualisierungen**: Die Hauptanzeige zeigt die relevanten Diagramme und Analysen basierend auf Ihrer Auswahl.

### Photometer Statistik

#### Erster Plot: "Jährliche Anzahl der Nächte nach Bedingung"

**Beschreibung**:  
Dieser Plot zeigt die jährliche Anzahl von Nächten, die **zwei Bedingungen** erfüllen:

- **Lila Balken**: Nächte, bei denen **90% der Himmelstemperatur < 0°C** liegen.
- **Orange Balken**: Nächte, bei denen der maximale MSAS-Wert (Himmelshelligkeit) **> 21.3** ist.

**Bedingungen für die Filterung der Nächte**:

- `astronomical_night == 1` → Nur astronomische Nächte werden berücksichtigt.
- `sky_temperature < 0` → Himmelstemperatur liegt unter 0°C.
- `moon_illumination < 0.3` → Nächte mit geringer Mondbeleuchtung (unter 30%).

**Berechnung**:

1. Für jede Nacht (`night_id`) wird der höchste MSAS-Wert berechnet.
2. Nächte, die die oben genannten Bedingungen erfüllen, werden gezählt.
3. Die Ergebnisse werden pro **Jahr** aggregiert.
---

#### Zweiter Plot:

Anteil der Nächte mit max MSAS > 21.3 im Verhältnis zu Nächten mit Himmelstemperatur < 0°

**Beschreibung**:  
Dieser Plot zeigt den **prozentualen Anteil** der Nächte, bei denen der maximale MSAS-Wert > 21.3 ist, im Vergleich zu kalten Nächten.

- **Darstellung**: Ein **kurzer Strich** pro Jahr visualisiert den Anteil.
- **Trendlinie**: Eine gestrichelte Linie zeigt ab einem Datenvorkommen von drei Jahren den linearen Trend.

**Berechnung**:

- Nächte mit **90% der Himmelstemperatur < 0°C** gelten als **kalte Nächte**.

- `Anteil (%) = \( \frac{\text{Anzahl der Nächte mit MSAS > 21.3}}{\text{Anzahl der kalten Nächte}} \times 100 \)`

---

### Zusammenfassung

Der Plot visualisiert:

1. **Absolute Anzahl** dunkler und kalter Nächte pro Jahr.
2. **Anteil** der besonders dunklen Nächte (MSAS > 21.3) im Vergleich zu kalten Nächten.

**Filterbedingungen**:

- Nur astronomische Nächte.
- Himmelstemperatur < 0°C.
- Mondbeleuchtung < 30%.

### Analyse pro Jahr
Dieses Skript analysiert die von einem Photometer gesammelten Daten, um die jährlichen Trends bei der Qualität des Nachthimmels und der Temperatur zu untersuchen. Es identifiziert Nächte mit hoher Himmelsqualität (maximaler MSAS-Wert > 21,3) und solche, in denen die Himmelstemperatur überwiegend unter 0°C liegt. Schliesslich werden Diagramme erstellt, die die jährliche Verteilung und das Verhältnis dieser Nächte zeigen, um langfristige Veränderungen zu veranschaulichen. Schliesslich werden Diagramme erstellt, die die jährliche Verteilung und das Verhältnis dieser Nächte zeigen, um die langfristigen Veränderungen zu veranschaulichen.

#### 1. Daten filtern

Die Daten werden gefiltert, um folgende Bedingungen einzubeziehen:
- **Astronomische Nächte:** `astronomical_night == 1`
- **Himmelstemperaturen unter 0°C:** `sky_temperature < 0`

---

#### 2. Jahr extrahieren

Das Jahr wird aus der Zeit (`time`) extrahiert:  
`Jahr = Jahr(as.POSIXct(time, Format = "%Y-%m-%d %H:%M:%S"))`

---

#### 3. Maximaler MSAS pro Nacht

Für jede Nacht wird der maximale Helligkeitswert berechnet:  
`max_msas = max(msas)`

---

#### 4. Prozentsatz der Zeit unter 0°C

Für jede Nacht wird der Prozentsatz der Zeit berechnet, in der die Temperatur des Himmels unter 0°C lag:  
`sky_temp_below_zero_pct = (Summe(sky_temperature < 0) ÷ Anzahl der Messungen) × 100`

---

#### 5. Nächte mit MSAS > 21.3

Die Anzahl der Nächte, in denen der maximale MSAS-Wert 21.3 überschreitet, wird berechnet:  
`nights_over_21_3 = Summe(max_msas > 21.3)`

---

#### 6. Kalte Nächte (90% der Zeit unter 0°C)

Die Anzahl der Nächte, in denen mindestens 90% der Zeit die Himmelstemperatur unter 0°C lag, wird berechnet:  
`nights_cold = Summe(sky_temp_below_zero_pct ≥ 90)`

---

#### 7. Verhältnis zwischen Nächten mit MSAS > 21.3 und kalten Nächten

Das Verhältnis der Nächte mit hoher Himmelsqualität (MSAS > 21.3) zu den kalten Nächten wird in Prozent berechnet:
- **Wenn nights_cold > 0:**  
  `ratio = (nights_over_21_3 ÷ nights_cold) × 100`
- **Sonst:**  
  `ratio = 0`

---

#### 8. Durchschnittliche und jährliche Aggregation

Für jedes Jahr werden die folgenden Werte berechnet:
- **Nächte mit MSAS > 21.3:** `nights_over_21_3`
- **Kalte Nächte (< 0°C):** `nights_cold`
- **Verhältnis (%) zwischen den Kategorien:** `ratio`

---

#### 9. Zeitspanne für die Daten

Die minimale und maximale Zeit der Messungen wird berechnet, um den analysierten Zeitraum zu bestimmen:  
`Zeitspanne = [min(time), max(time)]`

---

#### 10. Diagramme

##### 10.1 Balkendiagramm: Anzahl der Nächte

Ein Balkendiagramm zeigt die jährliche Anzahl der Nächte in folgenden Kategorien:
- **Nächte mit MSAS > 21.3**
- **Kalte Nächte (< 0°C)**

Die Achsen des Diagramms sind:  
- **x-Achse:** Jahr  
- **y-Achse:** Anzahl der Nächte  

---

##### 10.2 Verhältnisdiagramm: Nächte mit MSAS > 21.3 vs. kalte Nächte

Ein Liniendiagramm zeigt das Verhältnis (%) der Nächte mit MSAS > 21.3 zu den kalten Nächten für jedes Jahr.  
Zusätzlich wird, wenn mindestens 3 Jahre verfügbar sind, eine **lineare Regression** berechnet, um langfristige Trends zu visualisieren.

---

### Analyse pro Monat

Dieses Skript verarbeitet Daten eines Photometers, um die nächtlichen Bedingungen eines bestimmten Monats zu analysieren. Es berechnet:
- Die minimale und maximale Himmelshelligkeit (MSAS) pro Nacht.
- Die Gesamtzeit pro Nacht, in der die Himmelshelligkeit einen bestimmten Schwellenwert überschreitet (z. B. MSAS > 21.3).
- Den Verlauf der Mondphase über den Monat.

---

#### 1. Daten filtern

Die Daten werden auf folgende Bedingungen gefiltert:
- **Astronomische Nächte**: Zeiträume, in denen der Himmel vollständig dunkel ist (`sun_alt <= -18`).
- **MSAS > 0**: Nur valide Helligkeitsmessungen werden berücksichtigt.
- **Monat und Jahr**: Nur Daten aus dem ausgewählten Monat werden analysiert.

---

#### 2. Jahr und Monat extrahieren

Für jede Messung werden Jahr und Monat aus dem Zeitstempel extrahiert:
`Jahr = Jahr(Zeit)`, `Monat = Monat(Zeit)`.

---

#### 3. Maximaler und minimaler MSAS pro Nacht

Für jede Nacht wird berechnet:
- **Maximale Helligkeit:** `max_msas = max(msas)`
- **Minimale Helligkeit:** `min_msas = min(msas)`

Diese Werte zeigen die Himmelsqualität jeder Nacht an. Ein hoher MSAS-Wert (> 21.3) bedeutet einen dunklen und klaren Himmel.

---

#### 4. Gesamtzeit mit MSAS > 21.3 pro Nacht

Die Gesamtzeit pro Nacht, in der der MSAS-Wert grösser als 21.3 ist, wird wie folgt berechnet:
- **Zeitdifferenz:** Die Zeit zwischen aufeinanderfolgenden Messungen wird berechnet:  
  `time_diff = Zeit(t+1) - Zeit(t)`
- **Nur gültige Zeitintervalle:** Zeitdifferenzen grösser als 200 Sekunden werden ausgeschlossen.
- **Summierte Zeit:** Die Gesamtzeit mit MSAS > 21.3 wird in Stunden umgerechnet:  
  `total_time_hours = Summe(time_diff) ÷ 3600`

---

#### 5. Bortle-Skala

Die Bortle-Klasse wird gemäss dem MSAS-Wert bestimmt:
- **Klasse 1:** MSAS ≥ 21.90
- **Klasse 2:** 21.50 ≤ MSAS < 21.90
- **Klasse 3:** 21.30 ≤ MSAS < 21.50
- **Klasse 4:** 20.80 ≤ MSAS < 21.30
- **Klasse 4.5:** 20.10 ≤ MSAS < 20.80
- **Klasse 5:** 19.10 ≤ MSAS < 20.10
- **Klasse 6-7:** 18.00 ≤ MSAS < 19.10
- **Klasse 8-9:** MSAS < 18.00

---

#### 6. Mondphase berechnen

Die Mondphase wird für jeden Tag des Monats analysiert:
- Werte reichen von 0 (Neumond) bis 1 (Vollmond).
- Der Verlauf der Mondphase wird über den Monat dargestellt.

---

#### 7. Diagramme erstellen

Das Skript erstellt drei Diagramme für den ausgewählten Monat:

1. **Minimale und maximale Helligkeit pro Nacht**:
   - Zeigt die **dunkelsten** und **hellsten** MSAS-Werte jeder Nacht.
   - Referenzlinie bei **MSAS = 21.3**, um einen dunklen Himmel zu markieren.

2. **Gesamtzeit mit MSAS > 21.3 pro Nacht**:
   - Zeigt die Zeit (in Stunden), in der die Himmelshelligkeit sehr gut war.

3. **Verlauf der Mondphase**:
   - Zeigt, wie sich die Mondphase (Neumond bis Vollmond) im Laufe des Monats verändert hat.

---

#### Zusammenfassung der Berechnungen

- **Höchste und niedrigste Helligkeit pro Nacht:**  
  `max_msas = max(msas)`  
  `min_msas = min(msas)`

- **Gesamtzeit pro Nacht mit MSAS > 21.3:**  
  `total_time_hours = Summe(time_diff) ÷ 3600`

- **Mondphase pro Tag:**  
  `moon_illumination = Werte von 0 bis 1`

Das Skript liefert somit eine vollständige Übersicht über die nächtlichen Bedingungen eines Monats.

---

### Analyse Einzelnächte

Dieses Skript verarbeitet die von einem Photometer (einem Instrument, das die Helligkeit des Himmels misst) erfassten Daten, um die nächtlichen Bedingungen auf der Grundlage der gemessenen Helligkeit (MSAS) und der Temperatur des Himmels zu analysieren.  
Schliesslich erzeugt es Diagramme, die die in den Nächten eines bestimmten Monats erfassten Daten darstellen.

#### 1. Daten filtern

Eine Zeile ist gültig, wenn:
- **MSAS > 0** (Helligkeitswert ist positiv)
- **Zeit ≠ leer** (die Zeitangabe fehlt nicht)
- **MSAS ≠ leer** (der Helligkeitswert fehlt nicht)

#### 2. Nachtzeitraum

- **Nachtbeginn:** Zeit = Tag + 16:00
- **Nachtende:** Zeit = nächster Tag + 09:00

#### 3. Astronomische Nacht

Die astronomische Nacht umfasst alle Momente, in denen:
**Sonnenhöhe < -18°**

#### 4. Zeiträume mit Temperaturen unter 0°C

- **Bedingung:** Temperatur < 0
- **Dauer des Zeitraums:**  
  Dauer = Zeit\_ende - Zeit\_beginn
- **Bedingung für Gültigkeit:**  
  Dauer ≥ 30 Minuten

#### 5. Bortle-Skala

Die Bortle-Klasse wird gemäss dem MSAS-Wert bestimmt:
- **Klasse 1:** MSAS ≥ 21.90
- **Klasse 2:** 21.50 ≤ MSAS < 21.90
- **Klasse 3:** 21.30 ≤ MSAS < 21.50
- **Klasse 4:** 20.80 ≤ MSAS < 21.30
- **Klasse 4.5:** 20.10 ≤ MSAS < 20.80
- **Klasse 5:** 19.10 ≤ MSAS < 20.10
- **Klasse 6-7:** 18.00 ≤ MSAS < 19.10
- **Klasse 8-9:** MSAS < 18.00

#### 6. Durchschnittliche Helligkeit während der Nacht

Durchschnittlicher MSAS = (Summe aller gültigen MSAS-Werte) ÷ (Anzahl gültiger Messungen)

#### 7. Referenzlinie

Die Referenzlinie für den Zielwert im Diagramm:  
**MSAS = 21.3**

#### 8. Dauer eines Intervalls

Die Dauer eines Intervalls wird berechnet als:  
**Dauer = Zeit\_ende - Zeit\_beginn**

---

## Erweiterungsmöglichkeiten
Es wurden 2 Hauptoptionen zur Erweiterung der Funktionalität des Dashboards berücksichtigt.  
1. Ermöglichung des Vergleichs von Photometern  
2. Bereitstellung der Möglichkeit, einen Bericht mit den durchgeführten Analysen herunterzuladen  

---

## Dokumentation und Support

Weitere Dokumentation und Hilfestellung finden Sie unter:

- [Anleitung zur Bedienung](https://nachthimmel-monitoring-gantrisch-docs.vercel.app/bedienungsanleitung)
- [GitHub Repository](https://github.com/NachthimmelMonitoringGantrisch/NachthimmelMonitoringGantrisch)

---
