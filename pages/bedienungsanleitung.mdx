# Bedienungsanleitung der Nachthimmelmonitoring-Anwendung Naturpark Gantrisch

Dies ist die Anleitung für die Nachthimmelmonitoring-Anwendung, die speziell für die Analyse und Visualisierung von Daten aus Photometermessungen im Naturpark Gantrisch entwickelt wurde.

## Installation

### Voraussetzungen

- **Docker**: Installieren Sie Docker in der Version `xyz` oder höher.
- **Systemanforderungen**: Ein Rechner mit **Windows 10** oder höher bzw. ein kompatibles Betriebssystem.
- **Internetverbindung**: Für den Zugriff auf aktuelle Daten und Software-Updates.

### Schritte zur Installation

Die Anleitung für die Installation finden Sie hier: [GitHub](https://github.com/NachthimmelMonitoringGantrisch/NachthimmelMonitoringGantrisch):

---

## Anwendung

### Übersicht der Anwendung

Die Anwendung besteht aus drei Haupttabs:

1. **Daten herunterladen**: Laden Sie die Daten basierend auf einem definierten Zeitraum und Photometer herunter.
2. **Photometer Analyse**: Visualisieren und analysieren Sie die Messdaten.
3. **Analyse Report**: Exportieren Sie Berichte über ausgewählte Analysen. (Diese Funktion ist nicht umgesetzt)

---

### 1. Daten herunterladen

In diesem Tab können Sie Messdaten aus einem definierten Zeitraum abrufen:

- **Zeitraum-Auswahl**: Wählen Sie über den **Datumsbereich-Selektor** einen Zeitraum aus.
- **Photometer-Auswahl**: Wählen Sie über die **Metadatentabelle** einen oder mehrere Photometer aus.
- **Daten herunterladen**: Drücken Sie den Button **Daten herunterladen**, um die Daten in einer Tabelle anzuzeigen.
- **Statusbereich**: Statusmeldungen werden im **Statusbereich** angezeigt, um den Status des Downloads zu überwachen.

---

### 2. Photometer Analyse

Im **Photometer Analyse**-Tab können Sie aus verschiedenen Analysen wählen:

#### Auswahlmöglichkeiten

- **Photometer Statistik**: Zeigt detaillierte Statistiken zu den gesammelten Daten an.
- **Analyse pro Jahr**: Histogramme der Daten eines oder mehrerer Jahre.
- **Analyse pro Monat**: Grafiken für monatliche Messwerte (Minimum, Maximum).
- **Analyse Einzelnächte**: Detailanalysen einzelner Nächte.
- **Photometer Vergleich**: Vergleicht Daten von zwei ausgewählten Photometern. (Diese Funktion ist nicht umgesetzt)

#### Bedienung

- **Analyse Typ wählen**: Nutzen Sie die Dropdown-Menüs, um den gewünschten Analysemodus und die entsprechenden Parameter (z. B. Jahr, Monat, Photometer) auszuwählen.
- **Dynamische Visualisierungen**: Die Hauptanzeige zeigt die relevanten Diagramme und Analysen basierend auf Ihrer Auswahl.

### 2. Photometer Analyse - Berechnungen

#### Photometer Statistik

#### Analyse pro Jahr

#### Analyse pro Monat

#### Analyse Einzelnächte

##### Definition der Nachtzeit

Die Nacht ist definiert als der Zeitraum, der um 16:00 Uhr UTC am angegebenen Tag beginnt und um 09:00 Uhr UTC am folgenden Tag endet. 
Dieser Ansatz ermöglicht es, sowohl die Abend- als auch die frühen Morgenstunden einzubeziehen. 
Ist der Tag der letzte des Monats, wird die Frist bis zum nächsten Tag verlängert.

```r
# Definition von Beginn und Ende der Nachtzeit
start_datetime <- ymd_hms(paste(year, month, sprintf("%02d", day), "16:00:00"), tz = "UTC")

if (day == days_in_month(ymd(paste(year, month, "01")))) {
  end_datetime <- ymd_hms(paste(year, month, sprintf("%02d", day), "23:59:59"), tz = "UTC") + hours(9)
} else {
  end_datetime <- ymd_hms(paste(year, month, sprintf("%02d", day + 1), "09:00:00"), tz = "UTC")
}
```

---

##### Filtern von Daten

Die Daten werden so gefiltert, dass nur die Daten für den Nachtzeitraum und gültige **MSAS**-Werte (positiv und ungleich Null) berücksichtigt werden. 
Darüber hinaus wird der Zeitraum der **astronomischen Nacht** ermittelt, der als die Zeit definiert ist, in der die Höhe der Sonne (`sun_alt`) weniger als -18° beträgt.

```r
# Filterung der Daten für den Nachtzeitraum
df_night <- df %>%
  filter(time >= start_datetime, time <= end_datetime)

# Identifizierung der astronomischen Nachtzeit
night_intervals <- df_night %>%
  filter(sun_alt <= -18) %>%
  summarise(
    start_night = min(time),
    end_night = max(time),
    .groups = "drop"
  )
```

---

##### Temperaturbereiche unter 0°C

Intervalle, in denen die Himmelstemperatur (**sky_temperature**) unter 0°C liegt, werden identifiziert und zu kontinuierlichen Segmenten gruppiert. 
Nur Intervalle mit einer Dauer von mindestens **30 Minuten** werden als gültig angesehen.

```r
# Identifizierung von Temperaturbereichen unter Null Grad
df_night <- df_night %>%
  mutate(temp_below_zero = ifelse(sky_temperature < 0, 1, 0)) %>%
  arrange(time) %>%
  mutate(below_zero_group = cumsum(c(0, diff(temp_below_zero) != 0)))

# Berechnung der gültigen Intervalle
df_grouped <- df_night %>%
  group_by(below_zero_group) %>%
  summarise(
    start_time = min(time[temp_below_zero == 1], na.rm = TRUE),
    end_time = max(time[temp_below_zero == 1], na.rm = TRUE),
    duration = as.numeric(difftime(max(time[temp_below_zero == 1], na.rm = TRUE), min(time[temp_below_zero == 1], na.rm = TRUE), units = "mins")),
    .groups = "drop"
  ) %>%
  filter(duration >= 30)  # Conserva solo gli intervalli di durata >= 30 minuti
```

---

##### Bortle-Skala

Die Qualität des Nachthimmels wird anhand der **Bortle-Skala** klassifiziert, die **MSAS**-Werte (mag/arcsec²) mit Himmelsqualitätsstufen verknüpft. 
Jede Ebene ist durch eine bestimmte Farbe gekennzeichnet, was die Visualisierung und Interpretation erleichtert.

```r
# Bortle-Skala
bortle_scale <- data.frame(
  min_msas = c(21.90, 21.50, 21.30, 20.80, 20.10, 19.10, 18.00, -Inf),
  max_msas = c(Inf, 21.90, 21.50, 21.30, 20.80, 20.10, 19.10, 18.00),
  color = c("#2E2E2E", "#404040", "#0000FF", "#00FF00", "#FFFF00", 
            "#FFA500", "#FF0000", "#FFFFFF"),
  bortle_class = c("1", "2", "3", "4", "4.5", "5", "6-7", "8-9")
)
```

---

##### Erstellung der Grafik

Das Diagramm kombiniert MSAS-Daten mit Informationen der Bortle-Skala und Temperaturbereichen unter dem Gefrierpunkt. 
Darüber hinaus werden astronomische Nachtzeiten angezeigt, um die wichtigsten Momente der Himmelsqualität hervorzuheben.

```r
# Erstellung von Diagrammen für die Nächte in einem Monat
p <- ggplot() +
  geom_rect(data = bortle_scale, aes(xmin = start_datetime, xmax = end_datetime, ymin = min_msas, ymax = max_msas, fill = bortle_class), 
            alpha = 0.1, inherit.aes = FALSE) +
  geom_line(data = df_night, aes(x = time, y = msas), color = "black", size = 1) +
  {if (nrow(df_grouped) > 0) {
    geom_rect(data = df_grouped, aes(xmin = start_time, xmax = end_time, fill = "Temperaturen unter Null"), ymin = 14, ymax = 15, alpha = 0.7)
  }} +
  geom_hline(aes(yintercept = 21.3, color = "MSAS Zielwert"), linetype = "dashed", size = 1) +
  geom_vline(data = night_intervals, aes(xintercept = as.numeric(start_night), color = "Nacht Start/Ende"), linetype = "dotted", size = 1) +
  geom_vline(data = night_intervals, aes(xintercept = as.numeric(end_night), color = "Nacht Start/Ende"), linetype = "dotted", size = 1) +
  scale_fill_manual(values = c(setNames(bortle_scale$color, bortle_scale$bortle_class), "Temperaturen unter Null" = "green"), name = "Bortle-Skala") +
  scale_x_datetime(
    limits = c(start_datetime, end_datetime),
    breaks = seq(start_datetime, end_datetime, by = "3 hours"),
    date_labels = "%H:%M"
  ) +
  scale_y_continuous(name = "MSAS [mag/arcsec²]", limits = c(15, 26), breaks = seq(15, 26, by = 2)) +
  labs(title = paste("MSAS für", sprintf("%02d", day), month.abb[month], year), x = "Zeit", y = "MSAS [mag/arcsec²]") +
  theme_minimal()
```
---

##### Resultate

Die folgende Grafik zeigt die Ergebnisse der Einzelnächte-Analyse für den Monat Dezember, einschließlich der MSAS-Werte, der Temperaturbereiche unter dem Gefrierpunkt und der astronomischen Nachtzeiten.

![Ergebnisgrafik](/images/Einzelnächte.png)

---

### 3. Analyse Report



---

## Dokumentation und Support

Weitere Dokumentation und Hilfestellung finden Sie unter:

- [Anleitung zur Bedienung](https://nachthimmel-monitoring-gantrisch-docs.vercel.app/bedienungsanleitung)
- [GitHub Repository](https://github.com/NachthimmelMonitoringGantrisch/NachthimmelMonitoringGantrisch)

---